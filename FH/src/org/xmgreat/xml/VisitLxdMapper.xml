<?xml version="1.0" encoding="UTF-8" ?>  
<!DOCTYPE mapper PUBLIC "-//ibatis.apache.org//DTD Mapper 3.0//EN" 
"http://ibatis.apache.org/dtd/ibatis-3-mapper.dtd">
<mapper namespace="org.xmgreat.mapper.VisitLxdMapper">

	<!-- 添加访问或赞的记录 -->
	<insert id="addVisit"
		parameterType="org.xmgreat.entity.VisitEntity">
		insert into visitTb
		values(seq_visit.nextval,#{userId},#{touserId},
		to_char(sysdate,'YYYY-MM-DD'),#{style})
	</insert>

	<!-- 更新访问或赞记录的时间 -->
	<update id="updateVisitTime"
		parameterType="org.xmgreat.entity.VisitEntity">
		update visitTb set time=to_char(sysdate,'YYYY-MM-DD')
		where userId=#{userId} and touserId=#{touserId} and style=#{style}
	</update>

	<!-- 查询访问或赞的所有记录 -->
	<select id="selectAllVisit"
		resultType="org.xmgreat.entity.VisitEntity"
		parameterType="org.xmgreat.entity.VisitEntity">
		select * from visitTb where 1=1
		<if test="userId!=0">
			and userId=#{userId}
		</if>
		<if test="touserId!=0">
			and touserId=#{touserId}
		</if>
		and style=#{style}
	</select>

	<!-- 查询访问或赞的单页记录 -->
	<select id="selectPageVisit"
		resultMap="visitMap"
		parameterType="org.xmgreat.entity.VisitEntity">
		select b.* from(select a.*,rownum rn from
		(select v.*,p.url,p.photoId from visitTb v left  outer  join phototb p 
		  on v.touserid=p.userid and p.parameter=1
		 where 1=1
		<if test="ve.userId!=0">
			and v.userId=#{ve.userId}
		</if>
		<if test="ve.touserId!=0">
			and v.touserId=#{ve.touserId}
		</if>
		and v.style=#{ve.style} order by time desc ) a
		where rownum &lt;= #{max}) b where rn &gt; #{min}
	</select>
	
	<resultMap type="org.xmgreat.entity.VisitEntity" id="visitMap">
		<id property="visitId" column="visitId" /><!-- 主键 -->
		<result property="visitId" column="visitId" />
		<result property="userId" column="userId" />
		<result property="touserId" column="touserId" />
		<result property="time" column="time" />
		<result property="style" column="style" />
		
		<association property="photoEntity" column="photoId"
			javaType="org.xmgreat.entity.PhotoEntity">
			<id property="photoId" column="photoId" /><!-- 主键 -->
			<result property="userId" column="userId" />
			<result property="URL" column="URL" />
		</association>
	</resultMap>
	
	
	<!-- 添加关注记录 -->
	<insert id="addFocus"
		parameterType="org.xmgreat.entity.FocusEntity">
		insert into focusTb
		values(seq_focus.nextval,#{userId},#{touserId},21,
		to_char(sysdate,'YYYY-MM-DD'))
	</insert>
	
	<!-- 查询关注所有记录 -->
	<select id="selectAllFocaus"
		resultType="org.xmgreat.entity.FocusEntity"
		parameterType="org.xmgreat.entity.FocusEntity">
		select * from focusTb where 1=1
		<if test="userId!=0">
			and userId=#{userId}
		</if>
		<if test="touserId!=0">
			and touserId=#{touserId}
		</if>	
	</select>
	
	<!-- 更新关注记录状态 -->
	<update id="updateFocusState"		
		parameterType="org.xmgreat.entity.FocusEntity">
		update focusTb set 	time=to_char(sysdate,'YYYY-MM-DD'),deleteId=#{deleteId}
		where userId=#{userId} and touserId=#{touserId}
	</update>
	
	<!-- 查询关注单页记录 -->
	<!-- <select id="selectPageFocus"
		resultMap="focusMap"
		parameterType="org.xmgreat.entity.FocusEntity">
		select b.* from(select a.*,rownum rn from
		(select f.*,p.url,p.photoId,u.lgtime from focusTb f left  outer  join phototb p 
		  on f.touserid=p.userid and p.parameter=1,userTb u
		 where 1=1
        
		<if test="fe.userId!=0">
			and f.userId=#{fe.userId} and  u.userid=f.touserId
		</if>
		<if test="fe.touserId!=0">
			and f.touserId=#{fe.touserId} and  u.userid=f.userId
		</if>
		and deleteId=21 order by time desc ) a
		where rownum &lt;= #{max}) b where rn &gt; #{min}
	</select>
	
	<resultMap type="org.xmgreat.entity.FocusEntity" id="focusMap">
		<id property="focusId" column="focusId" />主键
		<result property="focusId" column="focusId" />
		<result property="userId" column="userId" />
		<result property="touserId" column="touserId" />
		<result property="time" column="time" />
		<result property="deleteId" column="deleteId" />
		
		<association property="photoEntity" column="photoId"
			javaType="org.xmgreat.entity.PhotoEntity">
			<id property="photoId" column="photoId" />主键
			<result property="userId" column="userId" />
			<result property="URL" column="URL" />
		</association>
		<association property="photoEntity" column="userId"
			javaType="org.xmgreat.entity.UserEntity">
			<id property="userId" column="userId" />主键
			<result property="userId" column="userId" />
			<result property="lgTime" column="lgTime" />
		</association>
	</resultMap>
	 -->
	
	

</mapper>
	



	